这是技术方向的朋友们必须要 **重点掌握** 的内容，也是企业级项目在前期准备阶段必须要做的核心工作！什么是架构设计？为什么要做架构设计？怎么做好架构设计？下面展开讲讲。

## 一、什么是架构设计？
想象一下盖楼是怎么盖的，需要做哪些事？

是直接让工人去搬砖，叠砖么？还是让挖掘机来挖呀挖？

当然不是！

在盖楼之前，肯定会有一名建筑师，根据大楼的实际用途，地理位置、入驻需求等信息来绘制一份蓝图，蓝图上会规划大楼等外部外形、内部布局、结构细节等。

绘制好蓝图之后，建筑师还要确定每层楼房的框架和支撑结构，确保他们足够稳定，不会风一吹就塌了。

之后，建筑师还要根据大楼的实际用途和需求来规划每个楼层的用途。

做软件开发也一样，在我们“码农”实际动手写代码前，往往会有一个经验丰富的架构师，先绘制一份 **架构设计图**，规划好整个系统的全貌、系统规模、系统的结构。

架构师还要将系统按照功能和需求划分为各个模块，比如商城系统划分为用户模块、商品模块、订单模块等。并且确定各个模块的作用和交互协作方式，保证整个系统能够正常运作。不会出现一个功能故障，整个系统全部瘫痪的情况。

## 二、为什么要做架构设计？
如果在盖楼前，不先设计好大楼的结构，那么就难以保证大楼的安全和稳定性，风一吹整层楼就塌了。同理，在开发网站前，如果不先设计好网站的整体架构（比如不添加防火墙），后面可能一遇到网络攻击，整个系统就都无法访问了。

架构设计的核心目标：保证系统地 **稳定性、可靠性和可用性**。换句话说，起码要让系统能跑。

进行架构设计的另外一个重要原因，是系统的 **可扩展性**。建好的大楼很受欢迎，我们想在盖好的大楼上再增加几层楼，那么必须在最初就确保大楼的结构可以支撑额外的重量、能够线性地往上叠加，而不是浑然倒塌。

同理，如果想要网站能够应对日益增长的用户量和新业务功能，也必须有一个良好的架构设计来支持。不要出现网站用户数增多以后，网站无法访问的情况。

此外，好的架构设计也能提升**系统的性能和用户体验**。比如在商场内，合理安排电梯数和电梯位置，就能帮助用户快速到达想去的店铺；而网站的架构设计如果合理，比如用更少的分层完成同样的功能，那么就能更快的响应用户的操作。

总之，想让网站像摩天大楼一样支棱起来，前期的架构设计是必要的！

## 三、怎么做好架构设计
### 掌握方法论
做好架构设计的前提是具备一定的理论知识。所谓方法论，是指前人通过总结和归纳形成的一套 **特定问题的解决方案**。

有很多对架构设计有帮助的方法论。比如初学编程时接触到的面向对象设计、软件开发基本原则、23种经典设计模式、SOA面向服务架构、DDD领域驱动设计等。掌握这些方法论背后的思想，是做好架构设计的 **前提**。

### 学习经典架构
不妨站在巨人的肩膀上，学习一些前人总结和实践过的经典架构。

#### 1）分层架构
比如开发java企业级后端项目常用的三层架构，将系统分为表示层、业务逻辑层、数据访问层。

表示层负责接收用户请求，把用户输入的参数传递给业务逻辑层进行处理，并返回数据、页面等内容给用户。

业务逻辑层负责处理复杂的业务逻辑，比如调用AI能力完成智能对话、再进行加工处理、调用数据访问层将结果存到数据库中，也是我们做系统主要开发的部分。

数据访问层负责操作底层的数据源，比如对数据库，缓存，文件进行增删改查。

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38856890/1732871599166-0a00c8d0-1dc0-4eb5-a1f6-4eedf35b8efd.jpeg)

鱼聪明后端AI也是使用了分层结构，只不过在原有的三层基础架构上，在业务逻辑层和数据访问层之间又加了Manager层（通用逻辑层），将业务逻辑层经常调用的公共逻辑提取出来，便于复用。

#### 2）微服务架构
微服务的“微”是相对于“单体”项目的概念。微服务架构是指将完整的大型系统拆分为多个微小的、自治的服务，每个服务都能独立部署、独立扩展和维护、互不影响，服务之间通过网络通信进行协作，从而实现原本大型系统的完整功能。

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38856890/1732871984276-8cfe43f5-06e0-4852-924e-3a64ac92cb27.jpeg)

能够实现微服务设计的框架也很多，比如Java的SpringCloud、Apache Dubbo等，但是学习微服务更重要的是思想，即 **如何合理地拆分服务**。

并不是所有的项目所有的功能都是要拆成子服务的，比如并没有将用户模块和助手模块分离，原因是这两个模块的业务都不复杂、并且存在紧密的依赖，拆分后反而不利于维护了。

#### 3）事件驱动架构
在事件驱动架构中，各模块之间是通过事件（或者消息）的发布订阅模型进行通信的。

举个简单的例子，有两个模块：支付模块和会员模块，当用户支付成功后，支付模块会给会员模块发送一个“xx用户支付成功”的事件，会员模块收到这个事件后，给对应的用户开通会员即可。

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38856890/1732952472180-9d1e2e14-db99-4830-b8dd-93ff43a15725.jpeg)

但实际应用中，事件驱动架构往往会引入一个 **事件总线**，相当于一个中介，负责集中收集和下发事件。

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38856890/1732952744462-2d6659c3-66b9-4bcd-815f-b364ee7a8372.jpeg)

这样，各模块之间就实现了解耦（互不影响）。假如后续我想新增多个对话模块，只要将改模块和事件总线建立连接即可，不会影响到其他模块的运行。

### 关注需求和痛点
我们在学习过程中接触到的项目，几乎都可以套用上述几种主流的架构。但具体应该如何做好架构设计，一定要结合实际的需求和要解决的痛点去分析。“安全性”和“访问互通性”值得考虑。

#### 安全性
在表示层前加 高防服务器和Nginx防火墙，在表示层之后加分布式限流和权限校验处理（在表示层之前加也合理）。改进后的架构

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38856890/1732954021107-c0c6dbe8-7230-4457-9993-6cf524789a36.jpeg)

#### 访问互通性
有时候我们的模块需要依赖第三方服务来完成部分功能，但是第三方服务并不支持跨地区访问，网络无法互通，怎么办呢？

这时，我们有两个方案可选：

1）把整个系统都放在第三方服务所在的地区进行部署。

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38856890/1732954569198-a98c59fd-0473-441f-8b78-40ddd3c76bb6.jpeg)

2）在我们的模块和第三方服务之间搭建一个代理，让代理帮忙发送和响应请求。

![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38856890/1732954565517-fc18fc29-de59-4016-89f3-612346270b53.jpeg)

方案1的好处是方便，但缺点也很明显，整个系统都移到其他地区，也就意味着原本地区的用户访问系统的所有功能，速度都会变慢。

方案2的好处是只需要改变AI绘画模块发送的请求地址信息，而系统的其他功能性能完全不变；缺点是要搭建额外的服务、增加了实现成本。

### 超前思考
我们在做架构设计时，要养成超前思考的习惯，不能只针对现状，而是要提前预见系统未来可能的发展，预留足够的 **可扩展** 空间。

当然，超前思考也要有个度。要避免过度设计，不要提前去考虑绝对不可能发生的事情，不要提前去消耗远超增长的成本。

最后，要注意的是，架构设计是一个持续的过程，要根据业务的实际情况不断优化迭代。比如发现业务收益不高时，通过简化架构来降低成本；业务高速发展时，及时扩容服务来应对增长。

