# 典型回答


这也是一个比较典型的场景题，在用户尝试将商品加入购物车时，若设备断网，需要一个机制来确保在重新联网后，购物车中的商品能够正确地同步到服务器。



想要实现这个功能，需要有以下几方面的机制：

+ 客户端：
    - **本地缓存**： 当断网时，将商品加入购物车的请求缓存在本地。
    - **网络状态检测**： 定期检测网络状态，以便在恢复网络连接时触发同步操作。
    - **重试机制**： 需要有一个重试机制以确保请求能够成功发送。
+ 服务端：
    - **幂等性**： 确保服务器处理请求时是幂等的，即相同的请求多次发送不会导致副作用。



### 本地缓存


要实现客户端的本地缓存，可以使用本地数据库（如 SQLite）或文件存储来缓存购物车操作请求。



> SQLite是一个进程内的库，实现了自给自足的、无服务器的、零配置的、事务性的SQL 数据库引擎。
>



同时，需要设计一个数据结构来存储操作请求，包括商品ID、数量、操作类型（加入购物车、删除商品等）和时间戳等信息。



### 网络状态检测


使用系统提供的网络状态监听 API（例如，Android 的 `ConnectivityManager`）来检测网络连接的状态变化。当网络状态变为可用时，触发同步机制，将本地缓存的请求发送到服务器。



### 重试机制


这里可以考虑实现一个"指数退避"的重试策略，即每次重试的间隔时间逐渐增加，避免频繁请求导致的服务器压力。



> 指数退避算法是适用于网络应用的标准错误处理策略，使用这种策略时，客户端会定期重试失败的请求，并不断增加各次请求之间的延迟时间。客户端应对发送到 Memorystore for Redis 且返回 HTTP `5xx` 和 `429` 响应代码错误的所有请求使用指数退避算法。
>



### 幂等控制


因为网络连接恢复以后会重试，所以这里就可能存在重复处理的问题。所以幂等性一定要考虑。



想要确保每个请求的处理是幂等的，通常通过使用唯一的请求 ID 来实现。例如，生成唯一的请求 ID 并在服务器端存储，避免重复处理相同请求。



[✅如何解决接口幂等的问题？](https://www.yuque.com/hollis666/qyhor6/gz2qwl)

